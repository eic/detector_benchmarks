from itertools import product
import hashlib

DETECTOR_PATH = os.environ["DETECTOR_PATH"]
DETECTOR_VERSION = os.environ["DETECTOR_VERSION"]
SUBSYSTEM = "roman_pots"
BENCHMARK = "dense_neural_network"
DETECTOR_CONFIG = ["epic_ip6"]
NUM_EPOCHS_PZ = [100]
LEARNING_RATE_PZ = [0.01]
SIZE_INPUT_PZ = [4]
SIZE_OUTPUT_PZ = [1]
N_LAYERS_PZ = [3,6]
SIZE_FIRST_HIDDEN_LAYER_PZ = [128]
MULTIPLIER_PZ = [0.5]
LEAK_RATE_PZ = [0.025]
NUM_EPOCHS_PY = [100]
LEARNING_RATE_PY = [0.01]
SIZE_INPUT_PY = [3]
SIZE_OUTPUT_PY = [1]
N_LAYERS_PY = [3,6]
SIZE_FIRST_HIDDEN_LAYER_PY = [128]
MULTIPLIER_PY = [0.5]
LEAK_RATE_PY = [0.025]
NUM_EPOCHS_PX = [100]
LEARNING_RATE_PX = [0.01]
SIZE_INPUT_PX = [3]
SIZE_OUTPUT_PX = [1]
N_LAYERS_PX = [3,7]
SIZE_FIRST_HIDDEN_LAYER_PX = [128]
MULTIPLIER_PX = [0.5]
LEAK_RATE_PX = [0.025]
MAX_HASH = 6
NFILES = range(1,11)
NEVENTS_PER_FILE = [100]
NUM_TRAINING_INPUTS = [int(0.5*max(NFILES)),int(0.7*max(NFILES))]
MODEL_VERSION = [
    hashlib.sha512("_".join(map(str,x)).encode()).hexdigest()[:MAX_HASH]
    for x in product(
        NEVENTS_PER_FILE, NUM_TRAINING_INPUTS,
        NUM_EPOCHS_PZ, LEARNING_RATE_PZ, SIZE_INPUT_PZ, SIZE_OUTPUT_PZ, N_LAYERS_PZ, SIZE_FIRST_HIDDEN_LAYER_PZ, MULTIPLIER_PZ, LEAK_RATE_PZ,
        NUM_EPOCHS_PY, LEARNING_RATE_PY, SIZE_INPUT_PY, SIZE_OUTPUT_PY, N_LAYERS_PY, SIZE_FIRST_HIDDEN_LAYER_PY, MULTIPLIER_PY, LEAK_RATE_PY,
        NUM_EPOCHS_PX, LEARNING_RATE_PX, SIZE_INPUT_PX, SIZE_OUTPUT_PX, N_LAYERS_PX, SIZE_FIRST_HIDDEN_LAYER_PX, MULTIPLIER_PX, LEAK_RATE_PX
    )
]
INPUT_STEERING_FILE = "steering_file.py"

rule all:
  input:
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/raw_data/"+str(DETECTOR_VERSION)+"_{detector_config}_{index}.edm4hep.root",
           detector_config=DETECTOR_CONFIG,
           index=NFILES),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/processed_data/"+str(DETECTOR_VERSION)+"_{detector_config}_{index}.txt",
           detector_config=DETECTOR_CONFIG,
           index=NFILES),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/metadata/"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.txt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/model_pz_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.pt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/model_py_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.pt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/model_px_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.pt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/LossVsEpoch_model_pz_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.png",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/LossVsEpoch_model_py_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.png",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/LossVsEpoch_model_px_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.png",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION)



rule roman_pots_generate_events:
  input:
  output:
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/raw_data/"+str(DETECTOR_VERSION)+"_{detector_config}_{index}.edm4hep.root",
           detector_config=DETECTOR_CONFIG,
           index=NFILES)
  run:
    for detector_config, index in product(DETECTOR_CONFIG, NFILES):
      os.system("npsim --steeringFile "+str(INPUT_STEERING_FILE)+" --compactFile "+str(DETECTOR_PATH)+"/"+str(detector_config)+".xml --outputFile results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/raw_data/"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(index)+".edm4hep.root -N "+str(NEVENTS_PER_FILE))
    
rule preprocess_model_training_data:
  input:
    data = expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/raw_data/"+str(DETECTOR_VERSION)+"_{detector_config}_{index}.edm4hep.root",
           detector_config=DETECTOR_CONFIG,
           index=NFILES),
    script = "preprocess_model_training_data.cxx"
  output:
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/processed_data/"+str(DETECTOR_VERSION)+"_{detector_config}_{index}.txt",
           detector_config=DETECTOR_CONFIG,
           index=NFILES)
  run:
    for f_input in input.data:
      os.system("root -q -b "+str(input.script)+"\"(\\\""+str(f_input)+"\\\",\\\""+str(f_input.replace(".edm4hep.root",".txt").replace("raw_data","processed_data"))+"\\\")\"")
     
rule roman_pots_generate_neural_network_configs:
  input:   
  output:
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/metadata/"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.txt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION)        
  run:
    for detector_config, nevents_per_file, num_training_inputs, \
    num_epochs_pz, learning_rate_pz, size_input_pz, size_output_pz, n_layers_pz, size_first_hidden_layer_pz, multiplier_pz, leak_rate_pz, \ 
    num_epochs_py, learning_rate_py, size_input_py, size_output_py, n_layers_py, size_first_hidden_layer_py, multiplier_py, leak_rate_py, \
    num_epochs_px, learning_rate_px, size_input_px, size_output_px, n_layers_px, size_first_hidden_layer_px, multiplier_px, leak_rate_px in \
    product(DETECTOR_CONFIG, NEVENTS_PER_FILE, NUM_TRAINING_INPUTS,
    NUM_EPOCHS_PZ, LEARNING_RATE_PZ, SIZE_INPUT_PZ, SIZE_OUTPUT_PZ, N_LAYERS_PZ, SIZE_FIRST_HIDDEN_LAYER_PZ, MULTIPLIER_PZ, LEAK_RATE_PZ,
    NUM_EPOCHS_PY, LEARNING_RATE_PY, SIZE_INPUT_PY, SIZE_OUTPUT_PY, N_LAYERS_PY, SIZE_FIRST_HIDDEN_LAYER_PY, MULTIPLIER_PY, LEAK_RATE_PY,
    NUM_EPOCHS_PX, LEARNING_RATE_PX, SIZE_INPUT_PX, SIZE_OUTPUT_PX, N_LAYERS_PX, SIZE_FIRST_HIDDEN_LAYER_PX, MULTIPLIER_PX, LEAK_RATE_PX): 
      output_dir = "results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/metadata"  
      output_file = str(nevents_per_file)+"_"+str(num_training_inputs)+"_"+\
                    str(num_epochs_pz)+"_"+str(learning_rate_pz)+"_"+str(size_input_pz)+"_"+str(size_output_pz)+"_"+str(n_layers_pz)+"_"+str(size_first_hidden_layer_pz)+"_"+str(multiplier_pz)+"_"+str(leak_rate_pz)+"_"+\
                    str(num_epochs_py)+"_"+str(learning_rate_py)+"_"+str(size_input_py)+"_"+str(size_output_py)+"_"+str(n_layers_py)+"_"+str(size_first_hidden_layer_py)+"_"+str(multiplier_py)+"_"+str(leak_rate_py)+"_"+\
                    str(num_epochs_px)+"_"+str(learning_rate_px)+"_"+str(size_input_px)+"_"+str(size_output_px)+"_"+str(n_layers_px)+"_"+str(size_first_hidden_layer_px)+"_"+str(multiplier_px)+"_"+str(leak_rate_px)
      model_hash = hashlib.sha512(output_file.encode()).hexdigest()[:MAX_HASH]
      output_file_location = open(str(output_dir)+"/"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_hash)+".txt","w")
      output_file_content = "--input_files\nresults/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/processed_data/"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_\n"+\
                            "--model_version\n"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_hash)+"\n"+\
                            "--nevents_per_file\n"+str(nevents_per_file)+"\n"+\
                            "--num_training_inputs\n"+str(num_training_inputs)+"\n"+\
                            "--num_epochs_pz\n"+str(num_epochs_pz)+"\n"+\
                            "--learning_rate_pz\n"+str(learning_rate_pz)+"\n"+\
                            "--size_input_pz\n"+str(size_input_pz)+"\n"+\
                            "--size_output_pz\n"+str(size_output_pz)+"\n"+\
                            "--n_layers_pz\n"+str(n_layers_pz)+"\n"+\
                            "--size_first_hidden_layer_pz\n"+str(size_first_hidden_layer_pz)+"\n"+\
                            "--multiplier_pz\n"+str(multiplier_pz)+"\n"+\
                            "--leak_rate_pz\n"+str(leak_rate_pz)+"\n"+\
                            "--num_epochs_py\n"+str(num_epochs_py)+"\n"+\
                            "--learning_rate_py\n"+str(learning_rate_py)+"\n"+\
                            "--size_input_py\n"+str(size_input_py)+"\n"+\
                            "--size_output_py\n"+str(size_output_py)+"\n"+\
                            "--n_layers_py\n"+str(n_layers_py)+"\n"+\
                            "--size_first_hidden_layer_py\n"+str(size_first_hidden_layer_py)+"\n"+\
                            "--multiplier_py\n"+str(multiplier_py)+"\n"+\
                            "--leak_rate_py\n"+str(leak_rate_py)+"\n"+\
                            "--num_epochs_px\n"+str(num_epochs_px)+"\n"+\
                            "--learning_rate_px\n"+str(learning_rate_px)+"\n"+\
                            "--size_input_px\n"+str(size_input_px)+"\n"+\
                            "--size_output_px\n"+str(size_output_px)+"\n"+\
                            "--n_layers_px\n"+str(n_layers_px)+"\n"+\
                            "--size_first_hidden_layer_px\n"+str(size_first_hidden_layer_px)+"\n"+\
                            "--multiplier_px\n"+str(multiplier_px)+"\n"+\
                            "--leak_rate_px\n"+str(leak_rate_px)
      output_file_location.write(output_file_content)
      print(output_file_location)
      output_file_location.close()
         
rule roman_pots_train_neural_networks:
  input:
    script = "train_dense_neural_network.py"
  output:
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/model_pz_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.pt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/model_py_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.pt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/model_px_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.pt",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/LossVsEpoch_model_pz_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.png",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/LossVsEpoch_model_py_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.png",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION),
    expand("results/"+str(DETECTOR_VERSION)+"/{detector_config}/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/LossVsEpoch_model_px_"+str(DETECTOR_VERSION)+"_{detector_config}_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_{model_version}.png",
           detector_config=DETECTOR_CONFIG,
           model_version=MODEL_VERSION)

  run:
    for detector_config, model_version in product(DETECTOR_CONFIG,MODEL_VERSION):
      os.system("python "+str(input.script)+" results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/metadata/"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".txt")
      os.system("mv model_pz_"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".pt results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/")
      os.system("mv model_py_"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".pt results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/")
      os.system("mv model_px_"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".pt results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/trained_models/")
      os.system("mv LossVsEpoch_model_pz_"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".png results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/")
      os.system("mv LossVsEpoch_model_py_"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".png results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/")
      os.system("mv LossVsEpoch_model_px_"+str(DETECTOR_VERSION)+"_"+str(detector_config)+"_"+str(SUBSYSTEM)+"_"+str(BENCHMARK)+"_"+str(model_version)+".png results/"+str(DETECTOR_VERSION)+"/"+str(detector_config)+"/detector_benchmarks/"+str(SUBSYSTEM)+"/"+str(BENCHMARK)+"/artifacts/")

   


    
